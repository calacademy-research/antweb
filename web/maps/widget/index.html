<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Map Widget</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <style>html,body,#map{height:100%;margin:0}</style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="/sdk/config.js"></script>
  <script>
    const cfg = window.__MAP_SVC_CFG__ || {};
    const tileUrl = cfg.TILE_URL || "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";
    const tileAttr = cfg.TILE_ATTR || "Â© OpenStreetMap contributors";

    const url = new URL(location.href);
    const [clat, clng] = (url.searchParams.get("center") || "36,-120").split(",").map(Number);
    const zoom = +(url.searchParams.get("zoom") || 6);

    const map = L.map('map').setView([clat, clng], zoom);
    L.tileLayer(tileUrl, {maxZoom:19, attribution: tileAttr}).addTo(map);
    const cluster = L.markerClusterGroup();
    map.addLayer(cluster);

    function setMarkers(points) {
      cluster.clearLayers();
      (points || []).forEach(p => {
        if (typeof p.lat === "number" && typeof p.lng === "number") {
          cluster.addLayer(L.marker([p.lat, p.lng]).bindPopup(p.html || ""));
        }
      });
      if (cluster.getLayers().length) map.fitBounds(cluster.getBounds(), { padding: [30,30] });
    }

    window.addEventListener("message", (e) => {
      if (e.data && e.data.type === "setMarkers") setMarkers(e.data.points);
    });

    const markersParam = url.searchParams.get("markers");
    if (markersParam) {
      try { setMarkers(JSON.parse(decodeURIComponent(markersParam))); } catch(e){}
    }
  </script>
</body>
</html>
